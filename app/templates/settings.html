{% extends "_layout.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold">Settings</h1>
  </div>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="mb-4 p-3 rounded {% if category == 'success' %}flash-success{% elif category == 'error' %}flash-error{% else %}flash-info{% endif %}">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <form method="post" class="bg-white p-6 rounded shadow-md">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Site name</label>
        <input name="site_name" value="{{ settings.get('site_name','RoshTech CRM') }}" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Default sender email</label>
        <input name="mail_default_sender" value="{{ settings.get('mail_default_sender','no-reply@localhost') }}" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>

      <div class="md:col-span-2">
        <h3 class="font-semibold mt-4">SMTP Settings</h3>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700">SMTP host</label>
        <input name="mail_server" value="{{ settings.get('mail_server','') }}" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">SMTP port</label>
        <input name="mail_port" value="{{ settings.get('mail_port','25') }}" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">SMTP username</label>
        <input name="mail_username" value="{{ settings.get('mail_username','') }}" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">SMTP password</label>
        <input name="mail_password" value="{{ settings.get('mail_password','') }}" type="password" class="mt-1 block w-full border rounded px-3 py-2" />
      </div>
      <div class="md:col-span-2">
        <label class="inline-flex items-center mt-2">
          <input type="checkbox" name="mail_use_tls" value="1" class="form-checkbox" {% if settings.get('mail_use_tls') %}checked{% endif %} />
          <span class="ml-2">Use TLS</span>
        </label>
      </div>
    </div>

    <div class="mt-6">
      <button class="bg-blue-600 text-white px-4 py-2 rounded">Save settings</button>
      <button id="send-test-email" type="button" class="ml-3 bg-green-600 text-white px-4 py-2 rounded">Send test email</button>
    </div>
  </form>
</div>
<script>
document.getElementById('send-test-email').addEventListener('click', async function(){
  const resp = await fetch("{{ url_for('main.test_email') }}", {method:'POST'});
  if (!resp.ok) {
    const txt = await resp.text()
    alert('Test email failed: '+txt)
    return
  }
  alert('Test email sent (or logged). Check logs/inbox.')
})
</script>
{% endblock %}
